{% extends "_common/layout" %}

{% block main %}
  {% cache unless craft.config.cacheTagDisabled %}
    {% set featured = entry.featuredPost.first %}

    {% if featured | length %}
      {# omit featured from list of entries #}
      {% set entries = craft.entries.section('blog', 'media', 'news', 'notices').id('not '~featured.id).limit(entriesPerPage).find %}

    {% else %}
      {# featured is pulled from top of entries, so add an extra one #}
      {# set limit = entriesPerPage + 1 #}
      {# ERROR: Object of class Twig_Markup could not be converted to int #}
      {% set limit = entriesPerPage.__toString + 1 %}

      {% set entries = craft.entries.section('blog', 'media', 'news', 'notices').limit(limit).find %}
      {% set featured = entries | first %}
      {% set entries = entries | without(featured) %}

    {% endif %}

    {% set letters = craft.entries.section('letters').limit(entriesPerPage) %}

    {% embed "_common/home" %}
      {% block featured %}
        {{ p.featuredPost(featured) }}
      {% endblock %}

      {% block whatsNew %}
        <h2>What's New</h2>

        <ul class="posts">
        {% for entry in entries %}
          {{ p.post(entry, true) }}
        {% endfor %}
        </ul>

        <aside>
          <h2>Letters</h2>
          <div id="comments">
            <ul>
            {% for letter in letters %}
              <li>
                <h4><a href="/letters/{{ letter.postDate | date('Y/m/d') }}">{{ p.titleCase(letter.title) }}</a></h4>
                <p>{{ letter.letterContent | slice(0, 180) }} &hellip;</p>
                {{ p.authorNameOrLink(letter, 'user') }}
              </li>
            {% endfor %}
            </ul>
          </div>
        </aside>
      {% endblock %}
    {% endembed %}
  {% endcache %}
{% endblock %}

{% set js %}
  $(function() {
    $('ul.posts').scrollingContent();
  });
{% endset %}
{% includeJs js %}
