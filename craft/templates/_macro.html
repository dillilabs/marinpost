{% macro classActive(slug, segmentNo) %}
  {% set segmentNo = segmentNo | default(1) %}
  {% set segment = craft.request.segment(segmentNo | default(1)) %}

  {{ segment == slug ? 'class="active"' : null }}
{% endmacro %}

{% macro navLink(name, segmentNo) %}
  {% from _self import classActive as classActive %}
  {% set slug = name | lower %}

  <a href="{{ url(slug) }}" {{ classActive(slug, segmentNo) }}>{{ name }}</a>
{% endmacro %}

{% macro primaryImage(entry, transform) %}
{% spaceless %}
  {% set image = null %}
  {% set transform = transform | default('list') %}

  {% switch entry.section.handle %}
    {% case 'blog' %}
      {% set fieldName = 'blogImages' %}
    {% case 'media' %}
      {% set fieldName = 'mediaImages' %}
    {% case 'notice' %}
      {% set fieldName = 'noticeImages' %}
    {% default %}
      {% set fieldName = null %}
  {% endswitch %}

  {% if fieldName is not null %}
    {% set images = attribute(entry, fieldName) %}
    {% if images is defined %}
      {% for block in images.order('sortOrder asc').limit(1) %}
        {% set image = block.image.first %}
      {% endfor %}
    {% endif %}

    {% if image is not null %}
      {{ image.url(transform) }}
    {% else %}  
      /img/default-{{ transform }}.png
    {% endif %}
  {% else %}  
    /img/default-{{ transform }}.png
  {% endif %}
{% endspaceless %}
{% endmacro %}

{% macro contributorUrl(user) %}
  {% set slug = [user.firstName, user.lastName] | join('-') | lower | replace('/[^\\w]+/', '-') %}
  {% set base = "about/contributors" %}

  {{- url([base, user.id, slug] | join('/')) -}}
{% endmacro %}

{% macro authorLink(entry) %}
  {% from _self import contributorUrl as contributorUrl %}
  {% set author = entry.author %}

  {% if author.can("publish:{{ entry.section.id }}") %}
    <a href="{{ contributorUrl(author) }}">{{ author.name }}</a>
  {% else %}
    {{ author.name }}
  {% endif %}
{% endmacro %}

{% macro mainContent(entry) %}
  {% set mainContent = null %}

  {% switch entry.section.handle %}
    {% case 'blog' %}
      {% set mainContent = entry.blogContent %}
    {% case 'letter' %}
      {% set mainContent = entry.letterContent %}
    {% case 'media' %}
      {% set mainContent = entry.linkComments %}
    {% case 'news' %}
      {% set mainContent = entry.linkComments %}
    {% case 'notice' %}
      {% set mainContent = entry.noticeContent %}
  {% endswitch %}

  {{- mainContent -}}
{% endmacro %}

{% macro sectionUrl(entry) %}
  {% set sectionUrl = null %}

  {% switch entry.section.handle %}
    {% case 'notice' %}
      {% set sectionUrl = url('notices') %}
    {% default %}
      {% set sectionUrl = url(entry.section.handle) %}
  {% endswitch %}

  {{- sectionUrl -}}
{% endmacro %}

{% macro postImage(entry, transform) %}
  {% from _self import primaryImage as primaryImage %}

  {% set transform = transform | default('list') %}

  {% set image = primaryImage(entry, transform) %}

  {% if entry.section.handle == 'news' %}
    <img src="{{ image }}">
  {% else %}
    <a href="{{ entry.url }}"><img src="{{ image }}"></a>
  {% endif %}
{% endmacro %}

{% macro postTags(entry, unfiltered) %}
  {% from _self import sectionUrl as sectionUrl %}

  {% set unfiltered = unfiltered | default(false) %}

  <ul class="tags">
  {% if unfiltered %}
    <li><a href="{{ sectionUrl(entry) }}">{{ entry.section.name }}</a></li> | 
  {% endif %}
    <li><a href="TODO">{{ entry.primaryLocation.first }}</a></li> | 
    <li><a href="TODO">{{ entry.primaryTopic.first }}</a></li>
  </ul>
{% endmacro %}

{% macro postTitle(entry) %}
  {% from _self import authorLink as authorLink %}

  {% switch entry.section.handle %}
    {% case 'news' %}
      <h3>{{ entry.title }}</h3>
    {% default %}
      <h3><a href="{{ entry.url }}">{{ entry.title }}</a></h3>
  {% endswitch %}
{% endmacro %}

{% macro postBy(entry) %}
  {% from _self import authorLink as authorLink %}

  <div class="byline">By {{ authorLink(entry) }} - {{ entry.postDate | date('M d, Y') }} - {{ random(10) }} Comments</div>
{% endmacro %}

{% macro postSummary(entry) %}
  {% from _self import postTitle as postTitle %}
  {% from _self import postBy as postBy %}
  {% from _self import mainContent as mainContent %}

  {% set content = mainContent(entry) %}

  {% switch entry.section.handle %}
    {% case 'media' %}
      {{ postTitle(entry) }}
      {{ postBy(entry) }}
      <p>{{ content }} <a class="more" href="{{ entry.url }}">more »</a></p>
    {% case 'news' %}
      {{ postTitle(entry) }}
      {{ postBy(entry) }}
      <p>{{ content }} <a class="more" href="{{ entry.newsLink }}" target="_blank">READ ARTICLE</a></p>
    {% default %}
      {{ postTitle(entry) }}
      {{ postBy(entry) }}
      <p>{{ content | striptags | slice(0, 200) }} &hellip; <a class="more" href="{{ entry.url }}">more »</a></p>
  {% endswitch %}
{% endmacro %}

{% macro entry(entry, unfiltered, featured) %}
  {% from _self import postImage as postImage %}
  {% from _self import postTags as postTags %}
  {% from _self import postSummary as postSummary %}

  {% set unfiltered = unfiltered | default(false) %}
  {% set featured = featured | default(false) %}

  {% if featured %}
    {{ postImage(entry, 'hero') }}
    <div class="featured">
      {{ postTags(entry, unfiltered) }}
      {{ postSummary(entry) }}
    </div>
  {% else %}
    <li class="listing">
      {{ postImage(entry) }}
      <div class="post">
        {{ postTags(entry, unfiltered) }}
        {{ postSummary(entry) }}
      </div>          
    </li>
  {% endif %}
{% endmacro %}

{% macro errorList(errors) %}
  {% if errors %}
    <ul class="errors">
      {% for error in errors %}
        <li>{{ error }}</li>
      {% endfor %}
    </ul>
  {% endif %}
{% endmacro %}
