{% set sourceId = 3 %}
{% set folder = craft.s3direct.s3Folder(sourceId) %}
{% set s3 = craft.s3direct.s3UploadForm(sourceId) %}

{% set imageBlock = false %}
{% set image = false %}
{% set by = false %}
{% set errors = false %}
{% set key = 'new' %}

{% if entry %}
  {% set imageBlock = attribute(entry, imagesAttribute).first %}
  {% set image = imageBlock.image.first %}
  {% set by = imageBlock.by %}
  {% set errors = imageBlock.hasErrors %}
  {% set key = imageBlock.id | default('new') %}
{% endif %}

<img src="{{ image ? image.url('list') : '/img/default-list.png' }}" class="display-image" />
<label>Image</label>

{% if errors %}
  {{ f.errorList(imageBlock.allErrors) }}
{% endif %}

<div class="image-field inputs">
  <input type="hidden" name="fields[{{ imagesAttribute }}]">
  <input type="hidden" name="fields[{{ imagesAttribute }}][{{ key }}][type]" value="image">
  <input type="hidden" name="fields[{{ imagesAttribute }}][{{ key }}][fields][image]">
  <input type="hidden" name="fields[{{ imagesAttribute }}][{{ key }}][fields][image][]" {% if image %}value="{{ image.id }}"{% endif -%}>
  <input type="hidden" name="fields[{{ imagesAttribute }}][{{ key }}][fields][by]" {% if by %}value="{{ by }}"{% endif %}>
</div>

<div id="image-modal" title="{{ image ? 'Replace / Remove' : 'Upload / Select' }} Image">
  <div>
    <label for="image" class="required">Select an existing image</label>
    <select id="image-asset-id">
      <option value=""></option>
      {% if folder %}
        {% for asset in craft.assets.folderId(folder.id) %}
          <option value="{{ asset.id }}" {% if asset.id == image.id %}selected{% endif %} data-url="{{ asset.url('list') }}">
            {{ asset.filename }}
          </option>
        {% endfor %}
      {% endif %}
    </select>

    <div>
      <span class="fileinput-button">
        <span>Or upload a new .gif, .jpg or .png image file</span>
        <input id="image-fileupload" type="file" name="file" accept="image/gif,image/jpg,image/jpeg,image/png">
        <img class="s3direct image" src="/img/spinner.gif" style="display: none;"/>
      </span>

      <br>
      <div>
        <div class="s3direct image progress-bar progress-bar-success" style="width: 0%; height: 18px; background: green;"></div>
      </div>
    </div>

    <label for="image-by" class="required">Image by</label>
    <input type="text" id="image-by" autocomplete="off" {%- if by %}value="{{ by }}"{% endif %}>
  </div>
</div>

<a href="#" id="open-image-modal">{{ image ? 'Replace/Remove' : 'Upload/Select' }}</a>

{% set js %}
$(function() {
  var openImageModal = $('#open-image-modal');
  var imageModal = $('#image-modal');
  var imageFileUpload = $('#image-fileupload');
  var srcImageAssetId = $('select#image-asset-id');
  var srcImageBy = $('input#image-by');
  var targetImageAssetId = $('input[type=hidden][name$="[fields][image][]"]');
  var targetImageBy = $('input[type=hidden][name$="[fields][by]"]');
  var displayImage = $('img.display-image');
  var defaultImageUrl = '/img/default-list.png';

  var populateImageFromModal = function() {
    targetImageAssetId.val(srcImageAssetId.val());
    targetImageBy.val(srcImageBy.val());

    if (srcImageAssetId.val().length == 0) {
      displayImage.prop('src', defaultImageUrl);
    } else {
      displayImage.prop('src', srcImageAssetId.children(':selected').attr('data-url'));
    }
  };

  imageModal.dialog({
    autoOpen: false,
    modal: true,
    height: $(window).height() / 2,
    width: $(window).width() / 2,
    buttons: {
      OK: function() {
        populateImageFromModal();
        imageModal.dialog('close');
      },
      Cancel: function() {
        imageModal.dialog('close');
      }
    }
  });

  openImageModal.click(function(e) {
    e.preventDefault();
    imageModal.dialog('open');
  });

  imageFileUpload.s3direct({
    bucket: "{{ s3.bucket }}",
    subfolder: "{{ s3.subfolder }}",
    currentUserId: "{{ currentUser.id }}",
    policy: "{{ s3.policy }}",
    signature: "{{ s3.signature }}",
    accessKey: "{{ s3.keyId }}",
    assetsSourceId: {{ sourceId }},
    acceptFileTypes: /.+\.(gif|jpe?g|png)$/i,
    uploadProgressBarSelector: '.s3direct.image.progress-bar',
    updateIndexIndicatorSelector: 'img.s3direct.image',
    selectFilesSelector: 'select#image-asset-id',
    debug: true,
  });
});
{% endset %}

{% includeJs js %}
