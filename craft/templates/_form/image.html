{% set sourceId = 3 %}
{% set folder = craft.s3direct.s3Folder(sourceId) %}
{% set s3 = craft.s3direct.s3UploadForm(sourceId) %}

{% set assets = false %}
{% if folder %}
  {% set assets = craft.assets.folderId(folder.id).find %}
{% endif %}

{% set image = false %}
{% set errors = false %}
{% if entry %}
  {% set image = attribute(entry, imagesAttribute).first %}
  {% set errors = image.hasErrors %}
{% endif %}

{% set transform = 'list' %}
{% set excerptLength = 20 %}

<img src="{{ image ? image.url(transform) : '/img/default/'~transform~'/'~singularSection~'.jpg' }}" class="display-image" />
<label>Image</label>

{% if errors %}
  {{ f.errorList(imageBlock.allErrors) }}
{% endif %}

<input type="hidden" name="fields[{{ imagesAttribute }}]">

<div class="image-field inputs">
  <input type="hidden" name="fields[{{ imagesAttribute }}][]" {% if image %}value="{{ image.id }}"{% endif -%}>
</div>

<a href="#" id="open-image-modal">{{ image ? 'Replace Image' : 'Add an Image' }}</a>

<div id="image-modal" title="My Images" style="display: none;">
  <div>
    <div class="help">{{ n.siteMessage('my/images') }}</div>
  </div>

  <div>
    <div class="upload-wrapper">
      <span class="fileinput-button">
        <span>Upload an image</span>
        <input id="image-fileupload" type="file" name="file" accept="image/gif,image/jpg,image/jpeg,image/png">
        <img class="s3direct image" src="/img/spinner.gif" style="display: none;"/>
      </span>

      <div class="s3direct image progress-bar progress-bar-success"></div>
    </div>

    <div class="files-wrapper">
      <ul id="src-images" {% if not assets %}style="display: none;"{% endif %}>
        {% if folder %}
          {% for asset in assets %}
            <li data-asset-id="{{ asset.id }}"  data-asset-url="{{ asset.url(transform) }}" {% if asset.id == image.id %}class="selected"{% endif %}>
              <div><img src="{{ asset.url(transform) }}" /></div>
              <span class="title">{{ p.excerpt(asset.filename, excerptLength) }}</span>
            </li>
          {% endfor %}
        {% endif %}
      </ul>
    </div>
  </div>
</div>

{% set js %}
$(function() {
  var openImageModal = $('#open-image-modal');
  var imageModal = $('#image-modal');
  var imageFileUpload = $('#image-fileupload');
  var srcImages = $('ul#src-images');
  var okButton = false;
  var targetImageId = $('input[type=hidden][name="fields[{{ imagesAttribute }}][]"]');
  var displayImage = $('img.display-image');
  var defaultImageUrl = '/img/default-{{ transform }}.png';
  var deleteButton = false;
  var deleteAssetUrl = '{{ actionUrl("mpEntry/deleteAsset") }}';
  
  var selectedImage = function() {
    return srcImages.children('li.selected:first');
  }

  var selectImage = function(li) {
    li.parent().children().removeClass('selected');
    li.addClass('selected');
  };
  
  var populateListFromIndex = function(files) {
    var selectedId = selectedImage().attr('data-asset-id');
    srcImages.children().remove();

    $.each(files, function(index, file) {
      var selected = file.id == selectedId ? 'class="selected"' : '';
      var name = file.filename.length > {{ excerptLength }} ? file.filename.slice(0, {{ excerptLength }})+'...' : file.filename;

      srcImages.append('<li data-asset-id="'+file.id+'" data-asset-url="'+file.url+'"' +selected+'><div><img src="'+file.url+'" /></div><span class="title">'+name+'</span></li>');
    });

    srcImages.show();
  };

  var updateOkButton = function() {
    okButton.button((selectedImage().length == 1) ? 'enable' : 'disable');
  };

  var populateImageFromModal = function() {
    var selectedImage = srcImages.children('li.selected:first');

    if (selectedImage.length == 1) {
      targetImageId.val(selectedImage.attr('data-asset-id')).trigger('change');
      displayImage.prop('src', selectedImage.attr('data-asset-url'));
    } else {
      targetImageId.val('').trigger('change');
      displayImage.prop('src', defaultImageUrl);
    }
  };

  var updateDeleteButton = function() {
    deleteButton.button((selectedImage().length == 1) ? 'enable' : 'disable');
  };

  var deleteImage = function() {
    var selectedImage = srcImages.children('li.selected:first');
    var assetId;

    if (selectedImage.length == 1) {
      assetId = selectedImage.attr('data-asset-id');

      $.post(deleteAssetUrl, { assetId: assetId }, function(data) {
        if (data.error) {
          alert(data.error);
        } else {
          selectedImage.remove();
          updateDeleteButton();
          updateOkButton();
        }
      });
    }
  };

  openImageModal.click(function(e) {
    e.preventDefault();
    imageModal.dialog('open');
  });

  imageModal.dialog({
    modal: true,
    autoOpen: false,
    height: $(window).height() * 0.75,
    width: $(window).width() * 0.75,
    dialogClass: 'no-close',
    buttons: {
      OK: function() {
        populateImageFromModal();
        imageModal.dialog('close');
      },
      Cancel: function() {
        imageModal.dialog('close');
      },
      Delete: function() {
        deleteImage();
      }
    },
    open: function(event, ui) {
      var widget = $(this).dialog('widget');
      okButton = widget.find('.ui-dialog-buttonpane button:contains(OK)');
      updateOkButton();
      deleteButton = widget.find('.ui-dialog-buttonpane button:contains(Delete)');
      updateDeleteButton();
    },
    closeOnEscape: false,
  });

  srcImages.on('click', 'li', function(e) {
    selectImage($(this));
    updateOkButton();
    updateDeleteButton();
  });

  imageFileUpload.s3direct({
    bucket: "{{ s3.bucket }}",
    subfolder: "{{ s3.subfolder }}",
    currentUserId: "{{ currentUser.id }}",
    policy: "{{ s3.policy }}",
    signature: "{{ s3.signature }}",
    accessKey: "{{ s3.keyId }}",
    assetsSourceId: {{ sourceId }},
    acceptFileTypes: /.+\.(gif|jpe?g|png)$/i,
    uploadProgressBarSelector: '.s3direct.image.progress-bar',
    updateIndexIndicatorSelector: 'img.s3direct.image',
    onUpdateAssetsIndex: populateListFromIndex,
    requireFileCredit: true,
    debug: true,
  });
});
{% endset %}
{% includeJs js %}

{% set css %}
img.display-image {
  width: 160px;
}

.upload-wrapper {
  width: 20%;
  float: left;
}
.files-wrapper {
  width: 80%;
  float: right;
}
.progress-bar.progress-bar-success {
  display: block;
  width: 0%;
  height: 10px;
  margin-top: 10px;
  background: green;
}

ul#src-images {
  list-style: none;
}
ul#src-images li {
  height: 160px;
  width: 160px;
  margin: 14px 0 0 14px;
  float: left;
}
ul#src-images li .title {
  font-size: 12px;
}
ul#src-images li.selected {
  background: #d5d8dd;
}

.no-close .ui-dialog-titlebar-close {
  visibility: hidden;
}

.clear {
  clear: both;
}
{% endset %}
{% includeCss css %}
