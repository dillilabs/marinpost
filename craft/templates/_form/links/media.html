{% set sourceId = 2 %}
{% set folder = craft.s3direct.s3Folder(sourceId) %}
{% set s3 = craft.s3direct.s3UploadForm(sourceId) %}

{% set mediaType = 'video' %}
{% set linkBlock = false %}

{% set videoUrl = false %}
{% set documentUrl = false %}

{% set document = false %}
{% set documentTitle = false %}

{% set errors = false %}
{% set key = 'new1' %}

{% if entry %}
  {% set linkBlock =  entry.mediaLink.first %}
  {% set mediaType = linkBlock.type %}

  {% switch mediaType %}
    {% case 'video' %}
      {% set videoUrl = linkBlock.videoUrl %}

    {% case 'document' %}
      {% set documentUrl = linkBlock.documentUrl %}

    {% case 'upload' %}
      {% set document = linkBlock.document.first %}
      {% set documentTitle = linkBlock.documentTitle %}
  {% endswitch %}

  {% set errors = mediaBlock.hasErrors %}
  {% set key = mediaBlock.id | default('new1') %}
{% endif %}

<div class="field">
    <label for="mediaLink" class="required">Media Link <span class="note">* required</span></label>
    
    <input type="hidden" name="fields[mediaLink]">
    <input type="hidden" name="fields[mediaLink][{{ key }}]">
    <input type="hidden" name="fields[mediaLink][{{ key }}][type]" id="mediaType" value="{{ mediaType }}">
    
    <input type="hidden" id="originalMediaType" value="{{ mediaType }}">
    <input type="hidden" id="originalMediaLinkBlockId" value="{{ key }}">
    
    <input type="radio" name="mediaTypeSelect" value="video" {%- if mediaType == 'video' %}checked="checked"{% endif -%}>Link Video
    <input type="radio" name="mediaTypeSelect" value="document" {%- if mediaType == 'document' %}checked="checked"{% endif -%}>Link Document
    <input type="radio" name="mediaTypeSelect" value="upload" {%- if mediaType == 'upload' %}checked="checked"{% endif -%}>Upload Document
    
    <input type="text" name="fields[mediaLink][{{ key }}][fields][videoUrl]" class="mediaLink video required" autocomplete="off" maxlength="255" value="{{ videoUrl }}" placeholder="http://example.com/video" {%- if mediaType != 'video' %}style="display:none;"{% endif -%}>
    <input type="text" name="fields[mediaLink][{{ key }}][fields][documentUrl]" class="mediaLink document required" autocomplete="off" maxlength="255" value="{{ documentUrl }}" placeholder="http://example.com/document.pdf" {%- if mediaType != 'document' %}style="display:none;"{% endif -%}>
    
    <input type="hidden" name="fields[mediaLink][{{ key }}][fields][document]" class="mediaLink upload">
    <select class="s3direct mediaLink upload required array" name="fields[mediaLink][{{ key }}][fields][document][]" {%- if mediaType != 'upload' %}style="display:none;"{% endif -%}>
      <option value=""></option>
    {% if folder %}
      {% for asset in craft.assets.folderId(folder.id) %}
        <option value="{{ asset.id }}" {% if asset.id == document.id %}selected{% endif %}>{{ asset.filename }}</option>
      {% endfor %}
    {% endif %}
    </select>
    
    <label for="documentTitle" class="mediaLink upload" {%- if mediaType != 'upload' %}style="display:none;"{% endif -%}>Document title</label>
    <input type="text" name="fields[mediaLink][{{ key }}][fields][documentTitle]" class="mediaLink upload" autocomplete="off" maxlength="255" placeholder="Title of document (optional)" value="{{ documentTitle }}" {%- if mediaType != 'upload' %}style="display:none;"{% endif -%}>
    
    <div class="file upload mediaLink" {%- if mediaType != 'upload' %}style="display: none;"{% endif -%}>
      <span class="fileinput-button">
          <span>Upload a Document</span>
          <input id="document-fileupload" type="file" name="file" accept="application/pdf">
          <img class="s3direct document" src="/img/spinner.gif" style="display: none;"/>
      </span>

      <br class="clear"><br>
      <div>
          <div class="s3direct document progress-bar progress-bar-success" style="width: 0%; height: 18px; background: green;"></div>
      </div>
    </div>
    
    {% if linkBlock %}
      {{ f.errorList(linkBlock.allErrors) }}
    {% endif %}
</div>

{% set js %}
$(function() {
  var srcDocument = $('select.s3direct.mediaLink');

  var populateSelectOptionsFromIndex = function(files) {
    var selectedId = srcDocument.val();
    srcDocument.children().remove().end().append('<option value=""></option>');

    $.each(files, function(index, file) {
      var selected = file.id == selectedId ? 'selected' : '';
      srcDocument.append('<option value="'+file.id+'" '+selected+' data-url="'+file.url+'">'+file.filename+'</option>');
    });
  };

  $('#document-fileupload').s3direct({
    bucket: "{{ s3.bucket }}",
    subfolder: "{{ s3.subfolder }}",
    currentUserId: "{{ currentUser.id }}",
    policy: "{{ s3.policy }}",
    signature: "{{ s3.signature }}",
    accessKey: "{{ s3.keyId }}",
    assetsSourceId: {{ sourceId }},
    acceptFileTypes: /.+\.pdf$/i,
    uploadProgressBarSelector: '.s3direct.document.progress-bar',
    updateIndexIndicatorSelector: 'img.s3direct.document',
    onUpdateAssetsIndex: populateSelectOptionsFromIndex,
    debug: true,
  });
});
{% endset %}

{% includeJs js %}
